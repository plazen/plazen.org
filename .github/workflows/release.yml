# This workflow automates versioning and GitHub Releases using semantic-release.
# It runs only on the 'main' branch after tests have passed.

name: Release

on:
  push:
    branches:
      - main # Only run releases from the main branch

permissions:
  contents: write # To create releases, tags, and commit version bumps
  issues: write # To comment on issues
  pull-requests: write # To comment on pull requests

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    if: |
      ${{ github.event.head_commit.message != 'chore(release): cut new release' &&
      github.event.head_commit.message != 'chore(release): initial release' }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: ðŸ”§ Install dependencies
        run: npm ci
      - name: ðŸ§ª Run tests
        run: npm test
      # - name: Build project
      #   run: npm run build

      - name: ðŸš€ Semantic Release
        uses: cycjimmy/semantic-release-action@v4
        with:
          branches: |
            [
              'main'
            ]
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
